{% extends 'base.html' %}

{% block title %}Dashboard - Shakti{% endblock %}

{% block head %}
<style>
/* Summary Report Section */
.summary-report-section {
  margin-bottom: 40px;
}

.summary-card {
  background: var(--glass-bg);
  border: 1px solid var(--glass-border);
  border-radius: var(--border-radius-lg);
  padding: 30px;
  backdrop-filter: var(--glass-backdrop);
  box-shadow: var(--glass-shadow);
}

.summary-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 20px;
}

.summary-title {
  font-size: 1.8rem;
  font-weight: 600;
  color: var(--text-primary);
  margin: 0;
}

.summary-stats {
  display: flex;
  gap: 30px;
}

.stat-item {
  text-align: center;
}

.stat-number {
  display: block;
  font-size: 2rem;
  font-weight: 700;
  color: var(--accent-blue);
  text-shadow: var(--neon-glow);
}

.stat-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  text-transform: uppercase;
  letter-spacing: 1px;
}

.summary-chart-container {
  position: relative;
  height: 300px;
}

.summary-chart-container canvas {
  width: 100% !important;
  height: 100% !important;
}

/* Responsive */
@media (max-width: 768px) {
  .summary-header {
    flex-direction: column;
    align-items: flex-start;
  }

  .summary-stats {
    width: 100%;
    justify-content: space-around;
  }

  .summary-chart-container {
    height: 250px;
  }
}
</style>
{% endblock %}

{% block content %}
  <div class="dashboard-content">
    <h1 class="page-title animate-fade-in-up">Dashboard</h1>
    {% if not available_data %}
      <div class="dashboard-empty animate-fade-in-up animate-stagger-1">No data has been uploaded yet. Please go to the <a href="{{ url_for('upload_page') }}">Upload Data</a> page to get started.</div>
    {% else %}
      <!-- Summary Report Section -->
      <div class="summary-report-section animate-fade-in-up animate-stagger-1"
           data-data-types='{{ available_data | tojson }}'>
        <div class="summary-card">
          <div class="summary-header">
            <h2 class="summary-title">Summary Report</h2>
            <div class="summary-stats">
              <div class="stat-item">
                <span class="stat-number">{{ available_data | length }}</span>
                <span class="stat-label">Data Types</span>
              </div>
              <div class="stat-item">
                <span class="stat-number">{{ available_data | sum(attribute='metadata.rows') | default(0) }}</span>
                <span class="stat-label">Total Records</span>
              </div>
            </div>
          </div>
          <div class="summary-chart-container">
            <div class="chart-loader spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <canvas id="summary-chart" style="display: none;"></canvas>
          </div>
        </div>
      </div>

      <div class="dashboard-cards">
        {% for data in available_data[:2] %}
        <div class="card-modern animate-scale-in animate-stagger-{{ loop.index }}">
          <div class="card-header-modern">
            <span class="card-title">{{ data.type.replace('_', ' ') | capitalize }}</span>
            <span class="card-meta">Rows: <b>{{ "{:,}".format(data.metadata.rows) }}</b> &nbsp;|&nbsp; Columns: <b>{{ data.metadata.columns }}</b></span>
          </div>
          <div class="card-body-modern">
            <div class="chart-container">
              <div class="chart-loader spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <canvas class="summary-chart" data-type="{{ data.type }}" style="display: none;"></canvas>
            </div>
          </div>
          <div class="card-footer">
            <a href="{{ url_for('graph_page') }}?data_type={{ data.type }}" class="btn btn--primary hover-lift">View Details</a>
          </div>
        </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const chartCanvases = document.querySelectorAll('.summary-chart');
    const chartColors = [
        'rgba(54, 162, 235, 0.6)',
        'rgba(255, 99, 132, 0.6)',
        'rgba(75, 192, 192, 0.6)',
        'rgba(255, 206, 86, 0.6)'
    ];

    // Load summary chart
    const summarySection = document.querySelector('.summary-report-section');
    if (summarySection) {
        const summaryCanvas = document.getElementById('summary-chart');
        const summaryContainer = summaryCanvas.parentElement;
        const summaryLoader = summaryContainer.querySelector('.chart-loader');

        // Get data from data attribute
        const dataTypes = JSON.parse(summarySection.getAttribute('data-data-types'));

        const labels = dataTypes.map(item => item.type.replace('_', ' ').toUpperCase());
        const data = dataTypes.map(item => item.metadata.rows);

        summaryLoader.style.display = 'none';
        summaryCanvas.style.display = 'block';
        new Chart(summaryCanvas, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Number of Records',
                    data: data,
                    backgroundColor: 'rgba(0, 212, 255, 0.6)',
                    borderColor: 'rgba(0, 212, 255, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: 'Data Records Summary' }
                },
                scales: { y: { beginAtZero: true } }
            }
        });
    }

    chartCanvases.forEach((canvas, index) => {
        const dataType = canvas.getAttribute('data-type');
        const container = canvas.parentElement;
        const loader = container.querySelector('.chart-loader');

        fetch(`/chart_data/best/${dataType}`)
            .then(response => response.json())
            .then(chartData => {
                loader.style.display = 'none';
                if (chartData.error) {
                    console.error(`Error fetching chart data for ${dataType}:`, chartData.error);
                    container.innerHTML = `<div class="text-center text-danger p-3">Could not load chart: ${chartData.error}</div>`;
                    return;
                }

                canvas.style.display = 'block';
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: chartData.labels,
                        datasets: [{
                            label: `Count of ${chartData.column_name}`,
                            data: chartData.data,
                            backgroundColor: chartColors[index % chartColors.length],
                            borderColor: chartColors[index % chartColors.length].replace('0.6', '1'),
                            borderWidth: 1
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, title: { display: true, text: `Top Values for ${chartData.column_name}` } }, scales: { y: { beginAtZero: true } } }
                });
            })
            .catch(error => {
                loader.style.display = 'none';
                container.innerHTML = `<div class="text-center text-danger p-3">Could not load chart. See console for details.</div>`;
                console.error(`Failed to fetch chart data for ${dataType}:`, error);
            });
    });
});
</script>
{% endblock %}
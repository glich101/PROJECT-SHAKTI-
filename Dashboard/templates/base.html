<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Shakti Analytics - Cyber Forensics Dashboard{% endblock %}</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Main CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">

    {% block head %}{% endblock %}
</head>
<body>
    <div class="dashboard-layout">
        <!-- Sidebar -->
        <aside class="sidebar-modern">
            <!-- Sidebar Header -->
            <div class="sidebar-header">
                <!-- Gujarat Police Logo -->
                <div class="gujarat-police-logo">
                    <img src="{{ url_for('static', filename='img/shakti-logo.jpg') }}" alt="Gujarat Police" class="police-logo-img">
                    <div class="police-text">
                        <div class="police-title">GUJARAT POLICE</div>
                        <div class="police-subtitle">Cyber Crime Unit</div>
                    </div>
                </div>

                <div class="sidebar-logo">
                    <i class="fas fa-shield-alt"></i>
                    <span class="sidebar-title">SHAKTI</span>
                </div>
                <div class="sidebar-subtitle">CDR Analytics</div>
            </div>

            <!-- Sidebar Menu -->
            <nav class="sidebar-menu">
                <a href="{{ url_for('homepage') }}" class="sidebar-link{% if request.endpoint == 'homepage' %} active{% endif %}">
                    <i class="fas fa-home"></i>
                    <span>Home</span>
                </a>

                <a href="{{ url_for('index') }}" class="sidebar-link{% if request.endpoint == 'index' %} active{% endif %}">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>

                <a href="{{ url_for('upload_page') }}" class="sidebar-link{% if request.endpoint == 'upload_page' %} active{% endif %}">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Upload Data</span>
                </a>

                <a href="{{ url_for('graph_page') }}" class="sidebar-link{% if request.endpoint == 'graph_page' %} active{% endif %}">
                    <i class="fas fa-chart-bar"></i>
                    <span>View Graphs</span>
                </a>

                <a href="{{ url_for('map_page') }}" class="sidebar-link{% if request.endpoint == 'map_page' %} active{% endif %}">
                    <i class="fas fa-map-marked-alt"></i>
                    <span>Map View</span>
                </a>

                <a href="{{ url_for('reports_page') }}" class="sidebar-link{% if request.endpoint == 'reports_page' %} active{% endif %}">
                    <i class="fas fa-file-alt"></i>
                    <span>Reports</span>
                </a>

                <a href="{{ url_for('settings_page') }}" class="sidebar-link{% if request.endpoint == 'settings_page' %} active{% endif %}">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </a>

                <a href="{{ url_for('user_management_page') }}" class="sidebar-link{% if request.endpoint == 'user_management_page' %} active{% endif %}">
                    <i class="fas fa-users-cog"></i>
                    <span>User Management</span>
                </a>

                <a href="{{ url_for('role_management_page') }}" class="sidebar-link{% if request.endpoint == 'role_management_page' %} active{% endif %}">
                    <i class="fas fa-user-shield"></i>
                    <span>Role Management</span>
                </a>
            </nav>

            <!-- Officer ID Card -->
            <div class="sidebar-user-profile">
                <div class="user-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="user-info">
                    {% if session.get('user') %}
                        <div class="user-name">Officer ID: {{ session.user.officer_id }}</div>
                        <div class="user-role">{{ session.user.role | title }}</div>
                    {% else %}
                        <div class="user-name">Not Logged In</div>
                        <div class="user-role">Guest Access</div>
                    {% endif %}
                </div>
            </div>

            <!-- Reset Button -->
            <div class="sidebar-footer">
                {% if session.get('user') %}
                    <a href="{{ url_for('logout') }}" class="btn-reset-modern" style="background: #dc3545; margin-bottom: 10px;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                {% endif %}
                <button class="btn-reset-modern" onclick="resetAllData(this)">
                    <i class="fas fa-trash-alt"></i>
                    <span>Reset Data</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="content-area">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="d-flex align-items-center justify-content-between w-100">
                    <div class="d-flex align-items-center">
                        <!-- Mobile menu toggle -->
                        <button class="sidebar-toggle-btn d-md-none me-3" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h1 class="mb-0 fw-bold text-primary">
                            {% if request.endpoint == 'homepage' %}
                                <i class="fas fa-home me-2"></i>Shakti Analytics
                            {% elif request.endpoint == 'index' %}
                                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                            {% elif request.endpoint == 'upload_page' %}
                                <i class="fas fa-cloud-upload-alt me-2"></i>Upload Data
                            {% elif request.endpoint == 'graph_page' %}
                                <i class="fas fa-chart-bar me-2"></i>Graph Analytics
                            {% elif request.endpoint == 'map_page' %}
                                <i class="fas fa-map-marked-alt me-2"></i>Map View
                            {% else %}
                                <i class="fas fa-shield-alt me-2"></i>Shakti Analytics
                            {% endif %}
                        </h1>
                    </div>

                    <div class="d-flex align-items-center gap-3">
                        <!-- Current time -->
                        <div class="text-secondary small d-none d-lg-block">
                            <i class="fas fa-clock me-1"></i>
                            <span id="currentTime"></span>
                        </div>

                        <!-- Status indicator -->
                        <div class="status-indicator">
                            <div class="status-dot status-active"></div>
                            <span class="status-text d-none d-md-inline">System Online</span>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                {% for category, message in messages %}
                  <div class="alert alert-{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'info' }} alert-dismissible fade show position-fixed" style="top: 80px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="fas fa-{{ 'check-circle' if category == 'success' else 'exclamation-triangle' if category == 'error' else 'info-circle' }}"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                  </div>
                {% endfor %}
              {% endif %}
            {% endwith %}

            <!-- Page Content -->
            <div class="main-content-area">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


    <!-- Custom JavaScript -->
    <script>
        // Sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar-modern');
            sidebar.classList.toggle('sidebar-open');
        }

        // Close sidebar when clicking outside on mobile
        document.addEventListener('click', function(event) {
            const sidebar = document.querySelector('.sidebar-modern');
            const toggleBtn = document.querySelector('.sidebar-toggle-btn');

            if (window.innerWidth <= 768 &&
                !sidebar.contains(event.target) &&
                !toggleBtn.contains(event.target) &&
                sidebar.classList.contains('sidebar-open')) {
                sidebar.classList.remove('sidebar-open');
            }
        });

        // Update current time
        function updateTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('en-US', {
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('currentTime').textContent = timeString;
        }

        // Update time every second
        updateTime();
        setInterval(updateTime, 1000);

        // Add loading states to links
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.addEventListener('click', function(e) {
                if (!this.classList.contains('active')) {
                    // Add loading state
                    this.style.opacity = '0.7';
                    this.innerHTML += ' <i class="fas fa-spinner fa-spin"></i>';
                }
            });
        });

        // Handle window resize
        window.addEventListener('resize', function() {
            if (window.innerWidth > 768) {
                document.querySelector('.sidebar-modern').classList.remove('sidebar-open');
            }
        });

        // Add page load animation
        document.addEventListener('DOMContentLoaded', function() {
            document.body.classList.add('fade-in');

            // Animate cards on load
            const cards = document.querySelectorAll('.card-modern');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in-up');
                }, index * 100);
            });
        });

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            // Could show user-friendly error message here
        });

        // Handle unhandled promise rejections
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            // Could show user-friendly error message here
        });

        // Global reset function
        function resetAllData(buttonElement) {
            if (confirm('Are you sure you want to delete all uploaded data? This cannot be undone.')) {
                if (buttonElement) buttonElement.focus();
                fetch('/reset', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            window.location.reload();
                        } else {
                            alert('Failed to reset data: ' + (data.message || 'Unknown error'));
                        }
                    })
                    .catch(error => {
                        console.error('Reset error:', error);
                        alert('Failed to reset data. Please try again.');
                    });
            }
        }

        // Service Worker Registration for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/js/map-service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered successfully:', registration.scope);

                        // Handle service worker updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', function() {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New version available - show update notification
                                    showUpdateNotification();
                                }
                            });
                        });
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Progressive enhancement check
        function checkProgressiveEnhancement() {
            const enhancements = {
                webgl: checkWebGLSupport(),
                serviceWorker: 'serviceWorker' in navigator,
                indexedDB: checkIndexedDBSupport(),
                webWorkers: 'Worker' in window,
                geolocation: 'geolocation' in navigator
            };

            console.log('Progressive enhancement features:', enhancements);
            window.appEnhancements = enhancements;

            return enhancements;
        }

        function checkWebGLSupport() {
            try {
                const canvas = document.createElement('canvas');
                return !!(window.WebGLRenderingContext &&
                          canvas.getContext('webgl'));
            } catch (e) {
                return false;
            }
        }

        function checkIndexedDBSupport() {
            return 'indexedDB' in window;
        }

        function showUpdateNotification() {
            // Remove existing notifications
            const existing = document.querySelectorAll('.update-notification');
            existing.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = 'update-notification alert alert-info alert-dismissible fade show position-fixed';
            notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                <i class="fas fa-sync-alt me-2"></i>
                <strong>Update Available!</strong> A new version is ready. Refresh to update.
                <button type="button" class="btn-close" onclick="location.reload()" aria-label="Refresh"></button>
            `;

            document.body.appendChild(notification);

            // Auto-remove after 30 seconds
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 30000);
        }

        // Initialize progressive enhancement check
        checkProgressiveEnhancement();
    </script>

    <!-- Gujarat Police Logo Badge -->
    <div class="gujarat-police-badge">
        <div class="police-badge-content">
            <img src="{{ url_for('static', filename='img/bg-logo.jpg') }}" alt="Gujarat Police" class="police-badge-img">
        </div>
    </div>

    {% block scripts %}{% endblock %}
</body>
</html>

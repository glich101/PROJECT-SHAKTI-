{% extends 'base.html' %}

{% block title %}View Graphs - Shakti{% endblock %}

{% block content %}
<div class="graph-page-container">
    <!-- Breadcrumbs -->
    <nav class="breadcrumb-nav">
      <div class="breadcrumb-container">
        <a href="{{ url_for('homepage') }}" class="breadcrumb-link">
          <i class="fas fa-home"></i>
          Home
        </a>
        <span class="breadcrumb-separator">/</span>
        <a href="{{ url_for('index') }}" class="breadcrumb-link">
          <i class="fas fa-tachometer-alt"></i>
          Dashboard
        </a>
        <span class="breadcrumb-separator">/</span>
        <span class="breadcrumb-current">
          <i class="fas fa-chart-bar"></i>
          View Graphs
        </span>
      </div>
    </nav>

    <div class="page-header">
      <h1 class="page-title">
        <i class="fas fa-chart-line"></i>
        Graph Analytics Dashboard
      </h1>
      <p class="page-subtitle">Advanced forensic data visualization and analysis tools</p>
    </div>

    <!-- Main Configuration Card -->
    <div class="graph-config-card card-modern">
      <div class="card-header-modern">
        <div class="card-icon">
          <i class="fas fa-cogs"></i>
        </div>
        <div class="card-title-section">
          <h3>Graph Configuration</h3>
          <p>Configure your forensic data visualization parameters</p>
        </div>
      </div>

      <div class="card-body-modern">
        <div class="config-grid">
          <!-- Data Type Selection -->
          <div class="config-item" data-bs-toggle="tooltip" data-bs-placement="top" title="Select the type of forensic data to analyze">
            <div class="input-icon">
              <i class="fas fa-database"></i>
            </div>
            <div class="input-content">
              <label for="dataTypeSelect" class="input-label">Data Type</label>
              <select id="dataTypeSelect" class="modern-select">
                <option selected disabled>Choose data type...</option>
                {% for dt in data_types %}
                  <option value="{{ dt }}" {% if request.args.get('data_type') == dt %}selected{% endif %}>{{ dt.replace('_', ' ') | capitalize }}</option>
                {% endfor %}
              </select>
            </div>
          </div>

          <!-- Column Selection -->
          <div class="config-item" data-bs-toggle="tooltip" data-bs-placement="top" title="Select 1-2 columns for visualization (1=Bar/Pie, 2=Scatter)">
            <div class="input-icon">
              <i class="fas fa-columns"></i>
            </div>
            <div class="input-content">
              <label for="columnSelect" class="input-label">Columns</label>
              <div class="position-relative">
                <select id="columnSelect" class="modern-multi-select" multiple size="6" disabled>
                  <!-- Options will be populated here -->
                </select>
                <div class="select-overlay-modern" id="selectOverlay">
                  <div class="overlay-content">
                    <i class="fas fa-list-ul"></i>
                    <span>Select data type first</span>
                  </div>
                </div>
              </div>
              <div id="columnCount" class="selection-indicator">
                <span class="indicator-dot"></span>
                <span id="selectedCount">0</span> columns selected
              </div>
            </div>
          </div>

          <!-- Chart Type Selection -->
          <div class="config-item" data-bs-toggle="tooltip" data-bs-placement="top" title="Choose visualization type: Bar/Pie/Histogram (1 col), Scatter (2+ cols), Heatmap/Bubble (2+ cols)">
            <div class="input-icon">
              <i class="fas fa-chart-pie"></i>
            </div>
            <div class="input-content">
              <label for="chartTypeSelect" class="input-label">Chart Type</label>
              <select id="chartTypeSelect" class="modern-select" disabled>
                <option value="auto" selected>Auto Detect</option>
                <option value="bar">Bar Chart</option>
                <option value="pie">Pie Chart</option>
                <option value="histogram">Histogram</option>
                <option value="line">Line Chart</option>
                <option value="area">Area Chart</option>
                <option value="scatter">Scatter Plot</option>
                <option value="box">Box Plot</option>
                <option value="violin">Violin Plot</option>
                <option value="heatmap">Heat Map</option>
                <option value="radar">Radar Chart</option>
                <option value="funnel">Funnel Chart</option>
                <option value="waterfall">Waterfall Chart</option>
                <option value="heatmap">Heat Map</option>
                <option value="bubble">Bubble Chart</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Generate Button -->
        <div class="action-section">
           <button id="generateGraphBtn" class="generate-btn" disabled>
             <span class="btn-icon">
               <i class="fas fa-play"></i>
             </span>
             <span class="btn-text">Generate Graph</span>
             <span class="btn-loading" style="display: none;">
               <i class="fas fa-spinner fa-spin"></i>
             </span>
           </button>

           <button id="showAllChartsBtn" class="generate-btn secondary-btn" disabled style="margin-left: 15px;">
             <span class="btn-icon">
               <i class="fas fa-th"></i>
             </span>
             <span class="btn-text">Show All Charts</span>
             <span class="btn-loading" style="display: none;">
               <i class="fas fa-spinner fa-spin"></i>
             </span>
           </button>
         </div>
      </div>
    </div>

    <!-- Advanced Options Card -->
    <div class="advanced-options-card card-modern">
      <div class="card-header-modern collapsed" data-bs-toggle="collapse" data-bs-target="#advancedOptions" aria-expanded="false">
        <div class="card-icon">
          <i class="fas fa-sliders-h"></i>
        </div>
        <div class="card-title-section">
          <h4>Advanced Options</h4>
          <p>Configure refresh settings and data parameters</p>
        </div>
        <div class="collapse-icon">
          <i class="fas fa-chevron-down"></i>
        </div>
      </div>

      <div class="collapse" id="advancedOptions">
        <div class="card-body-modern">
          <div class="advanced-grid">
            <div class="advanced-item">
              <div class="toggle-control">
                <div class="toggle-icon">
                  <i class="fas fa-sync-alt"></i>
                </div>
                <div class="toggle-content">
                  <label class="toggle-label">Auto Refresh</label>
                  <div class="form-check form-switch">
                    <input class="form-check-input modern-switch" type="checkbox" id="autoRefreshToggle">
                    <label class="form-check-label" for="autoRefreshToggle">Enable live updates</label>
                  </div>
                </div>
              </div>
            </div>

            <div class="advanced-item">
              <div class="input-icon-small">
                <i class="fas fa-clock"></i>
              </div>
              <div class="input-content">
                <label for="refreshInterval" class="input-label">Refresh Interval</label>
                <input id="refreshInterval" class="modern-input" type="number" min="1" max="300" value="5" placeholder="seconds">
              </div>
            </div>

            <div class="advanced-item">
              <div class="input-icon-small">
                <i class="fas fa-filter"></i>
              </div>
              <div class="input-content">
                <label for="topNInput" class="input-label">Top N Records</label>
                <input id="topNInput" class="modern-input" type="number" min="1" max="10000" value="50" placeholder="records">
              </div>
            </div>

            <div class="advanced-item">
              <div class="input-icon-small">
                <i class="fas fa-magic"></i>
              </div>
              <div class="input-content">
                <label for="detectChartType" class="input-label">Chart Detection</label>
                <select id="detectChartType" class="modern-select-small">
                  <option value="auto" selected>Auto Detect</option>
                  <option value="bar">Force Bar</option>
                  <option value="pie">Force Pie</option>
                  <option value="histogram">Force Histogram</option>
                  <option value="line">Force Line</option>
                  <option value="area">Force Area</option>
                  <option value="box">Force Box</option>
                  <option value="violin">Force Violin</option>
                  <option value="radar">Force Radar</option>
                  <option value="heatmap">Force Heatmap</option>
                </select>
              </div>
            </div>
          </div>

          <div class="advanced-actions">
            <button id="refreshNowBtn" class="refresh-btn">
              <i class="fas fa-refresh"></i>
              <span>Refresh Now</span>
            </button>
          </div>
        </div>
      </div>
    </div>


    <!-- Graph Display Area -->
    <div id="graph-container" class="graph-display-area card-modern">
      <div class="card-header-modern">
        <div class="card-icon">
          <i class="fas fa-chart-area"></i>
        </div>
        <div class="card-title-section">
          <h2>Data Visualization</h2>
          <p>Interactive charts and graphs generated from your forensic data</p>
        </div>
        <div class="card-actions">
          <button class="btn btn-modern btn-sm" onclick="window.print()" title="Print Chart">
            <i class="fas fa-print"></i>
          </button>
          <button class="btn btn-modern btn-sm" id="downloadChartBtn" title="Download Chart">
            <i class="fas fa-download"></i>
          </button>
        </div>
      </div>

      <div class="card-body-modern">
        <div class="graph-placeholder">
          <div class="placeholder-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h3 class="placeholder-title">Ready for Analysis</h3>
          <p class="placeholder-text">Configure your data source and columns above to generate forensic visualizations</p>
          <div class="placeholder-steps">
            <div class="step">
              <span class="step-number">1</span>
              <span>Select Data Type</span>
            </div>
            <div class="step">
              <span class="step-number">2</span>
              <span>Choose Columns</span>
            </div>
            <div class="step">
              <span class="step-number">3</span>
              <span>Generate Chart</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block head %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<style>
    /* Modern Graph Page Styles */
    .graph-page-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: calc(100vh - 80px);
    }

    /* Breadcrumb Styles for Graph Page */
    .breadcrumb-nav {
        width: 100%;
        margin-bottom: 20px;
        animation: slideInLeft 0.6s ease-out 0.4s both;
    }

    .breadcrumb-container {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
    }

    .breadcrumb-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: rgba(255, 255, 255, 0.7);
        text-decoration: none;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s ease;
        padding: 4px 8px;
        border-radius: 6px;
    }

    .breadcrumb-link:hover {
        color: var(--accent-blue);
        background: rgba(0, 212, 255, 0.1);
    }

    .breadcrumb-separator {
        color: rgba(255, 255, 255, 0.4);
        font-weight: bold;
    }

    .breadcrumb-current {
        color: var(--accent-blue);
        font-weight: 600;
    }

    /* Page Header */
    .page-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 20px 0;
        width: 100%;
    }

    /* Center the configuration cards */
    .graph-config-card, .advanced-options-card {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .page-title i {
        color: var(--accent-blue);
        text-shadow: var(--neon-glow);
        font-size: 2.8rem;
    }

    .page-subtitle {
        font-size: 1.1rem;
        color: var(--text-secondary);
        margin: 0;
        font-weight: 400;
    }

    /* Futuristic Cards */
    .graph-config-card, .advanced-options-card {
        background: linear-gradient(135deg, var(--secondary-dark) 0%, rgba(26, 26, 26, 0.95) 100%);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        box-shadow:
            0 8px 32px rgba(0, 0, 0, 0.3),
            0 0 0 1px rgba(0, 212, 255, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        margin-bottom: 30px;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .graph-config-card:hover, .advanced-options-card:hover {
        box-shadow:
            0 12px 40px rgba(0, 0, 0, 0.4),
            0 0 0 1px rgba(0, 212, 255, 0.2),
            0 0 20px rgba(0, 212, 255, 0.1);
        transform: translateY(-2px);
    }

    /* Card Headers */
    .card-header-modern {
        background: linear-gradient(90deg, rgba(0, 212, 255, 0.1) 0%, rgba(138, 43, 226, 0.1) 100%);
        border-bottom: 1px solid var(--border-color);
        padding: 24px 30px;
        display: flex;
        align-items: center;
        gap: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .card-header-modern:hover {
        background: linear-gradient(90deg, rgba(0, 212, 255, 0.15) 0%, rgba(138, 43, 226, 0.15) 100%);
    }

    .card-header-modern.collapsed .collapse-icon i {
        transform: rotate(0deg);
    }

    .card-icon {
        width: 50px;
        height: 50px;
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--neon-glow);
        flex-shrink: 0;
    }

    .card-icon i {
        color: white;
        font-size: 20px;
    }

    .card-title-section h3, .card-title-section h4 {
        margin: 0 0 4px 0;
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--text-primary);
    }

    .card-title-section p {
        margin: 0;
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    .collapse-icon {
        margin-left: auto;
        transition: transform 0.3s ease;
    }

    .collapse-icon i {
        color: var(--accent-blue);
        font-size: 18px;
        transform: rotate(180deg);
    }

    /* Card Body */
    .card-body-modern {
        padding: 30px;
    }

    /* Configuration Grid */
    .config-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        margin-bottom: 30px;
    }

    .config-item {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 12px;
        padding: 20px;
        transition: all 0.3s ease;
        position: relative;
    }

    .config-item:hover {
        border-color: var(--accent-blue);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        transform: translateY(-2px);
    }

    .input-icon {
        position: absolute;
        top: 20px;
        left: 20px;
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
        z-index: 2;
    }

    .input-icon i {
        color: white;
        font-size: 16px;
    }

    .input-content {
        margin-left: 60px;
    }

    .input-label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Modern Select Elements */
    .modern-select, .modern-multi-select {
        width: 100%;
        padding: 12px 16px;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(0, 212, 255, 0.3);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .modern-select:focus, .modern-multi-select:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.2);
        outline: none;
    }

    .modern-select:disabled, .modern-multi-select:disabled {
        background: rgba(255, 255, 255, 0.02);
        border-color: var(--border-color);
        color: var(--text-secondary);
        cursor: not-allowed;
    }

    .modern-multi-select {
        min-height: 140px;
        max-height: 180px;
        resize: vertical;
    }

    .modern-select option, .modern-multi-select option {
        background: var(--secondary-dark);
        color: var(--text-primary);
        padding: 8px;
    }

    .modern-multi-select option:checked {
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple)) !important;
        color: white !important;
    }

    /* Selection Indicator */
    .selection-indicator {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-top: 12px;
        font-size: 13px;
        color: var(--text-secondary);
    }

    .indicator-dot {
        width: 8px;
        height: 8px;
        background: var(--accent-blue);
        border-radius: 50%;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* Modern Select Overlay */
    .select-overlay-modern {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        border-radius: 8px;
        z-index: 3;
        display: flex;
        align-items: center;
        justify-content: center;
        pointer-events: none;
        transition: all 0.3s ease;
    }

    .select-overlay-modern.hidden {
        opacity: 0;
        visibility: hidden;
    }

    .overlay-content {
        text-align: center;
        color: var(--text-secondary);
    }

    .overlay-content i {
        font-size: 32px;
        margin-bottom: 8px;
        display: block;
    }

    /* Generate Button */
    .generate-btn {
        background: linear-gradient(135deg, var(--accent-blue) 0%, var(--accent-purple) 100%);
        border: none;
        border-radius: 12px;
        padding: 16px 32px;
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        position: relative;
        overflow: hidden;
        min-width: 200px;
    }

    .generate-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .generate-btn:hover::before {
        left: 100%;
    }

    .generate-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 12px 35px rgba(0, 212, 255, 0.4);
    }

    .secondary-btn {
      background: linear-gradient(135deg, var(--accent-purple) 0%, var(--accent-blue) 100%);
      box-shadow: 0 8px 25px rgba(138, 43, 226, 0.3);
    }

    .secondary-btn:hover {
      box-shadow: 0 12px 35px rgba(138, 43, 226, 0.4);
    }

    .generate-btn:disabled {
        background: var(--border-color);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .generate-btn:disabled:hover {
        transform: none;
        box-shadow: none;
    }

    .btn-icon, .btn-text, .btn-loading {
        position: relative;
        z-index: 1;
    }

    /* Advanced Options Grid */
    .advanced-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }

    .advanced-item {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(0, 212, 255, 0.1);
        border-radius: 8px;
        padding: 16px;
        transition: all 0.3s ease;
    }

    .advanced-item:hover {
        border-color: var(--accent-blue);
        box-shadow: 0 0 15px rgba(0, 212, 255, 0.1);
    }

    .input-icon-small {
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 8px;
        box-shadow: 0 2px 8px rgba(0, 212, 255, 0.2);
    }

    .input-icon-small i {
        color: white;
        font-size: 14px;
    }

    .modern-input, .modern-select-small {
        width: 100%;
        padding: 10px 12px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 13px;
        transition: all 0.3s ease;
    }

    .modern-input:focus, .modern-select-small:focus {
        border-color: var(--accent-blue);
        box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.1);
        outline: none;
    }

    .toggle-control {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .toggle-icon {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
    }

    .toggle-icon i {
        color: white;
        font-size: 16px;
    }

    .toggle-content {
        flex: 1;
    }

    .toggle-label {
        display: block;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 4px;
    }

    .modern-switch {
        transform: scale(1.2);
    }

    .modern-switch:checked {
        background-color: var(--accent-blue);
        border-color: var(--accent-blue);
    }

    /* Advanced Actions */
    .advanced-actions {
        display: flex;
        justify-content: center;
    }

    .refresh-btn {
        background: linear-gradient(135deg, #28a745, #20c997);
        border: none;
        border-radius: 8px;
        padding: 12px 24px;
        color: white;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
    }

    .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    /* Graph Display Area */
    .graph-display-area {
        background: linear-gradient(135deg, var(--secondary-dark) 0%, rgba(26, 26, 26, 0.95) 100%);
        border: 1px solid var(--border-color);
        border-radius: 16px;
        min-height: 600px;
        padding: 20px;
        box-shadow:
            0 8px 32px rgba(0, 0, 0, 0.3),
            0 0 0 1px rgba(0, 212, 255, 0.1);
        backdrop-filter: blur(10px);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .graph-placeholder {
        text-align: center;
        max-width: 500px;
    }

    .placeholder-icon {
        font-size: 64px;
        color: var(--accent-blue);
        margin-bottom: 20px;
        text-shadow: var(--neon-glow);
    }

    .graph-placeholder h3 {
        color: var(--text-primary);
        font-size: 1.8rem;
        font-weight: 600;
        margin-bottom: 15px;
    }

    .graph-placeholder p {
        color: var(--text-secondary);
        font-size: 1rem;
        line-height: 1.6;
        margin-bottom: 20px;
    }

    .placeholder-hint {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 0.9rem;
        color: var(--accent-cyan);
    }

    .placeholder-hint i {
        color: var(--accent-blue);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .config-grid {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .graph-page-container {
            padding: 0 15px;
        }

        .page-title {
            font-size: 2rem;
        }

        .page-title i {
            font-size: 2.4rem;
        }

        .card-header-modern, .card-body-modern {
            padding: 20px;
        }

        .config-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .advanced-grid {
            grid-template-columns: 1fr;
        }

        .graph-display-area {
            padding: 30px 20px;
            min-height: 300px;
        }

        .placeholder-icon {
            font-size: 48px;
        }

        .graph-placeholder h3 {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 576px) {
        .page-title {
            font-size: 1.8rem;
            flex-direction: column;
            gap: 10px;
        }

        .generate-btn {
            padding: 14px 24px;
            font-size: 14px;
            min-width: 180px;
        }

        .card-header-modern {
            padding: 16px 20px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
        }

        .card-icon i {
            font-size: 16px;
        }
    }

    /* Loading States */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 16px;
    }

    .loading-content {
        text-align: center;
        color: var(--text-primary);
    }

    .loading-spinner-large {
        font-size: 48px;
        color: var(--accent-blue);
        margin-bottom: 20px;
        animation: spin 1s linear infinite;
    }

    .loading-text {
        font-size: 1.2rem;
        font-weight: 500;
        margin-bottom: 10px;
    }

    .loading-subtext {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }

    /* Charts Grid */
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 15px;
        width: 100%;
    }

    .chart-item {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(0, 212, 255, 0.2);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
    }

    .chart-item:hover {
        border-color: var(--accent-blue);
        box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
        transform: translateY(-2px);
    }

    .chart-header {
        margin-bottom: 10px;
        text-align: center;
    }

    .chart-header h4 {
        color: var(--accent-blue);
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0;
        text-shadow: 0 0 5px rgba(0, 212, 255, 0.3);
    }

    .chart-content {
        height: 300px;
        position: relative;
    }

    .mini-chart {
        width: 100%;
        height: 100%;
    }

    .chart-error {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--accent-red);
        text-align: center;
    }

    .chart-error i {
        font-size: 32px;
        margin-bottom: 10px;
    }

    .chart-error span {
        font-size: 0.9rem;
    }

    /* Charts Grid Loading */
    .charts-grid-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 400px;
        text-align: center;
    }

    /* Responsive Charts Grid */
    @media (max-width: 1200px) {
        .charts-grid {
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }

        .chart-content {
            height: 250px;
        }
    }

    /* Tooltip Enhancements */
    .tooltip-inner {
        background: var(--secondary-dark);
        color: var(--text-primary);
        border: 1px solid var(--accent-blue);
        font-size: 12px;
    }

    .tooltip-arrow::before {
        border-top-color: var(--secondary-dark) !important;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    console.log('Graph page loaded, initializing...');

    const dataTypeSelect = document.getElementById('dataTypeSelect');
    const columnSelect = document.getElementById('columnSelect');
    const chartTypeSelect = document.getElementById('chartTypeSelect');
    const generateGraphBtn = document.getElementById('generateGraphBtn');
    const autoRefreshToggle = document.getElementById('autoRefreshToggle');
    const refreshInterval = document.getElementById('refreshInterval');
    const refreshNowBtn = document.getElementById('refreshNowBtn');
    const topNInput = document.getElementById('topNInput');
    const detectChartType = document.getElementById('detectChartType');

    let refreshTimer = null;
    let availableColumns = [];
    let selectedColumns = [];

    console.log('Elements initialized:', {
        dataTypeSelect: !!dataTypeSelect,
        columnSelect: !!columnSelect,
        generateGraphBtn: !!generateGraphBtn
    });

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Enable/disable generate button based on selections
    function updateGenerateButtonState() {
        const hasDataType = dataTypeSelect.value && dataTypeSelect.value !== 'Choose data type...';
        const hasColumns = selectedColumns.length > 0;
        generateGraphBtn.disabled = !(hasDataType && hasColumns);
    }

    function showOverlay(message = 'Select a data type first', icon = 'fas fa-list-ul') {
        const overlay = document.getElementById('selectOverlay');
        if (overlay) {
            overlay.innerHTML = `
                <div class="overlay-content">
                    <i class="${icon}"></i>
                    <span>${message}</span>
                </div>
            `;
            overlay.classList.remove('hidden');
        }
    }

    function hideOverlay() {
        const overlay = document.getElementById('selectOverlay');
        if (overlay) {
            overlay.classList.add('hidden');
        }
    }

    function updateColumns(dataType) {
        console.log('Loading columns for data type:', dataType);

        // Validate dataType
        if (!dataType || dataType === 'Choose data type...') {
            console.log('Invalid data type selected');
            return;
        }

        columnSelect.disabled = true;
        columnSelect.innerHTML = '<option>Loading columns...</option>';
        showOverlay('Loading columns...', 'fas fa-spinner fa-spin');

        // Fetch column metadata
        fetch(`/data/${encodeURIComponent(dataType)}`)
            .then(response => {
                console.log('Metadata endpoint response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Metadata endpoint data:', data);

                // Handle error responses
                if (data.error) {
                    columnSelect.innerHTML = `<option disabled>${data.error}</option>`;
                    columnSelect.disabled = true;
                    chartTypeSelect.disabled = true;
                    hideOverlay();
                    showErrorMessage(data.error, 'warning');
                    return;
                }

                // Handle both success and "no data" cases
                availableColumns = data.column_names || [];

                if (availableColumns.length === 0) {
                    // No data uploaded yet
                    columnSelect.innerHTML = '<option disabled>No data uploaded for this type</option>';
                    columnSelect.disabled = true;
                    chartTypeSelect.disabled = true;
                    hideOverlay();
                    showErrorMessage(`No data uploaded for ${dataType}. Please upload data first.`, 'warning');
                    return;
                }

                console.log('Found', availableColumns.length, 'columns:', availableColumns);
                populateColumnSelect();
                columnSelect.disabled = false;
                chartTypeSelect.disabled = false;
                hideOverlay();

                // Auto-select first column if none selected
                if (selectedColumns.length === 0 && availableColumns.length > 0) {
                    selectedColumns = [availableColumns[0]];
                    updateColumnSelectUI();
                    updateColumnCount();
                    updateGenerateButtonState();
                    // Don't auto-generate graph on initial load
                }
            })
            .catch(error => {
                console.error('Error loading columns:', error);
                columnSelect.disabled = true;
                columnSelect.innerHTML = '<option>Error loading columns</option>';
                chartTypeSelect.disabled = true;
                hideOverlay();
                showErrorMessage('Failed to load columns. Please check your connection and try again.', 'error');
            });
    }

    function populateColumnSelect() {
        console.log('Starting to populate select options...');
        console.log('columnSelect element:', columnSelect);
        console.log('availableColumns:', availableColumns);

        columnSelect.innerHTML = '';

        if (availableColumns.length === 0) {
            console.log('No columns available, showing message');
            columnSelect.innerHTML = '<option disabled>No columns available</option>';
            return;
        }

        console.log('Populating select options for', availableColumns.length, 'columns');

        // Create options
        availableColumns.forEach((col, index) => {
            console.log(`Creating option ${index} for column: "${col}"`);

            const option = document.createElement('option');
            option.value = col;
            option.textContent = col.trim(); // Simplified display
            option.selected = selectedColumns.includes(col);

            columnSelect.appendChild(option);

            console.log(`Option ${index} created and appended`);
        });

        console.log('Select options populated successfully. Total options created:', availableColumns.length);
    }


    function buildChartUrl(dataType, columns, specificChartType = null) {
        const top_n = parseInt(topNInput.value, 10) || 50;
        let chart_type_param = specificChartType;

        if (!chart_type_param) {
            if (detectChartType && detectChartType.value && detectChartType.value !== 'auto') {
                chart_type_param = detectChartType.value;
            } else if (chartTypeSelect && chartTypeSelect.value && chartTypeSelect.value !== 'auto') {
                chart_type_param = chartTypeSelect.value;
            }
        }

        console.log('Building URL with:', { dataType, columns, top_n, chart_type_param });

        let url = `/graph/${encodeURIComponent(dataType)}?`;
        columns.forEach((col, index) => {
            console.log(`Adding column ${index}: "${col}" -> "${encodeURIComponent(col)}"`);
            url += `column=${encodeURIComponent(col)}&`;
        });
        url += `top_n=${top_n}`;
        if (chart_type_param) {
            url += `&chart_type=${encodeURIComponent(chart_type_param)}`;
        }

        console.log('Final URL:', url);
        return url;
    }

    let isGeneratingGraph = false;

    function updateGraph() {
        const dataType = dataTypeSelect.value;

        if (!dataType || selectedColumns.length === 0 || isGeneratingGraph) return;

        isGeneratingGraph = true;

        // Show loading state on button
        generateGraphBtn.disabled = true;
        generateGraphBtn.innerHTML = `
            <span class="btn-icon">
                <i class="fas fa-spinner fa-spin"></i>
            </span>
            <span class="btn-text">Generating...</span>
            <span class="btn-loading" style="display: inline;">
                <i class="fas fa-spinner fa-spin"></i>
            </span>
        `;

        // Auto-detect chart type based on number of columns
        let chartType = 'bar'; // default
        if (chartTypeSelect.value !== 'auto') {
            chartType = chartTypeSelect.value;
        } else if (selectedColumns.length === 2) {
            chartType = 'scatter'; // default to scatter for 2 columns
        } else if (selectedColumns.length === 1) {
            // For single column, check if it's numeric for histogram
            chartType = 'bar'; // will be auto-detected by backend
        }

        const url = buildChartUrl(dataType, selectedColumns);
        console.log('Generated graph URL:', url);
        console.log('Selected columns for graph:', selectedColumns);

        // Show loading state in graph container
        const container = document.getElementById('graph-container');
        container.innerHTML = `
            <div class="loading-overlay">
                <div class="loading-content">
                    <div class="loading-spinner-large">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="loading-text">Generating Forensic Visualization</div>
                    <div class="loading-subtext">Processing ${selectedColumns.length} column${selectedColumns.length > 1 ? 's' : ''}...</div>
                </div>
            </div>
        `;

        fetch(url)
            .then(response => {
                console.log('Graph API response status:', response.status);
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('Graph API error response:', text);
                        throw new Error(`HTTP ${response.status}: ${text}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    console.error("Error fetching graph:", data.error);
                    container.innerHTML = `
                        <div class="alert alert-danger" style="background: rgba(220, 53, 69, 0.1); border: 1px solid #dc3545; color: #dc3545; border-radius: 8px; padding: 20px; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                            <strong>Visualization Error:</strong> ${data.error}
                        </div>
                    `;
                    return;
                }
                // Clear the container and create a new div for the plot
                container.innerHTML = '<div id="plotly-chart" style="width: 100%; height: 500px;"></div>';
                Plotly.newPlot('plotly-chart', data.data, data.layout, {responsive: true});
            })
            .catch(error => {
                console.error("Error fetching graph:", error);
                container.innerHTML = `
                    <div class="alert alert-danger" style="background: rgba(220, 53, 69, 0.1); border: 1px solid #dc3545; color: #dc3545; border-radius: 8px; padding: 20px; text-align: center;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <strong>Connection Error:</strong> Failed to load graph data. Please check your connection and try again.
                    </div>
                `;
            })
            .finally(() => {
                isGeneratingGraph = false;
                // Reset button state
                generateGraphBtn.disabled = false;
                generateGraphBtn.innerHTML = `
                    <span class="btn-icon">
                        <i class="fas fa-play"></i>
                    </span>
                    <span class="btn-text">Generate Graph</span>
                    <span class="btn-loading" style="display: none;">
                        <i class="fas fa-spinner fa-spin"></i>
                    </span>
                `;
            });
    }


    function startAutoRefresh() { stopAutoRefresh(); const intervalSec = Math.max(1, parseInt(refreshInterval.value, 10) || 5); refreshTimer = setInterval(() => updateGraph(), intervalSec * 1000); }
    function stopAutoRefresh() { if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; } }

    // Event Listeners
    dataTypeSelect.addEventListener('change', () => {
        const selectedValue = dataTypeSelect.value;
        console.log('Data type changed to:', selectedValue);

        if (!selectedValue || selectedValue === 'Choose a data type...') {
            console.log('No valid data type selected');
            // Reset everything
            stopAutoRefresh();
            selectedColumns = [];
            updateColumnCount();
            columnSelect.disabled = true;
            columnSelect.innerHTML = '<option disabled>Select data type first</option>';
            chartTypeSelect.disabled = true;
            showOverlay('Select a data type first', 'fas fa-list-ul');
            return;
        }

        stopAutoRefresh();
        selectedColumns = []; // Reset selections when data type changes
        updateColumnCount();
        // Reset select state
        columnSelect.disabled = true;
        chartTypeSelect.disabled = true;

        console.log('Loading columns for new data type');
        updateColumns(selectedValue);
    });

    function updateColumnCount() {
        const countElement = document.getElementById('selectedCount');
        const countDiv = document.getElementById('columnCount');

        if (countElement) {
            countElement.textContent = selectedColumns.length;
        }

        // Update styling based on count
        if (selectedColumns.length === 0) {
            countDiv.className = 'mt-1';
            if (countElement) countElement.className = 'text-muted';
        } else if (selectedColumns.length === 1) {
            countDiv.className = 'mt-1';
            if (countElement) countElement.className = 'text-success';
        } else if (selectedColumns.length === 2) {
            countDiv.className = 'mt-1';
            if (countElement) countElement.className = 'text-primary';
        }

        updateShowAllButtonState();
    }

    // Event listeners
    columnSelect.addEventListener('change', () => {
        console.log('Column select changed');
        const selectedOptions = Array.from(columnSelect.selectedOptions).map(option => option.value);

        console.log('Selected columns:', selectedOptions);

        // Validate selection limits
        if (selectedOptions.length > 2) {
            // Show warning instead of alert for better UX
            showSelectionWarning('Maximum 2 columns allowed for visualization');
            // Revert to previous selection
            setTimeout(() => {
                updateColumnSelectUI();
            }, 100);
            return;
        }

        if (selectedOptions.length === 0) {
            showSelectionWarning('Please select at least 1 column');
            // Revert to previous selection
            setTimeout(() => {
                updateColumnSelectUI();
            }, 100);
            return;
        }

        // Clear any warnings
        hideSelectionWarning();

        selectedColumns = selectedOptions;

        // Update chart type based on selection
        if (selectedColumns.length === 2 && chartTypeSelect.value === 'auto') {
            chartTypeSelect.value = 'scatter';
        } else if (selectedColumns.length === 1 && chartTypeSelect.value === 'scatter') {
            chartTypeSelect.value = 'auto';
        }

        updateColumnCount();
        updateGenerateButtonState();

        console.log('Updating graph');
        updateGraph();
        if (autoRefreshToggle.checked) startAutoRefresh();
    });

    function showSelectionWarning(message) {
        let warningDiv = document.getElementById('selectionWarning');
        if (!warningDiv) {
            warningDiv = document.createElement('div');
            warningDiv.id = 'selectionWarning';
            warningDiv.className = 'selection-limit-warning';
            document.getElementById('columnCount').appendChild(warningDiv);
        }
        warningDiv.textContent = message;
        warningDiv.style.display = 'block';
        setTimeout(() => {
            warningDiv.style.display = 'none';
        }, 3000);
    }

    function hideSelectionWarning() {
        const warningDiv = document.getElementById('selectionWarning');
        if (warningDiv) {
            warningDiv.style.display = 'none';
        }
    }

    function showErrorMessage(message, type = 'error') {
        // Remove existing messages
        const existingMessages = document.querySelectorAll('.error-message, .success-message');
        existingMessages.forEach(msg => msg.remove());

        // Create new message
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
        messageDiv.innerHTML = `
            <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
            ${message}
        `;

        // Insert at the top of the page content
        const pageContainer = document.querySelector('.graph-page-container');
        if (pageContainer) {
            pageContainer.insertBefore(messageDiv, pageContainer.firstChild);
        }

        // Auto-remove after 5 seconds
        setTimeout(() => {
            if (messageDiv.parentNode) {
                messageDiv.remove();
            }
        }, 5000);
    }

    function updateColumnSelectUI() {
        const options = columnSelect.querySelectorAll('option');
        options.forEach(option => {
            option.selected = selectedColumns.includes(option.value);
        });
    }

    // Generate Graph Button
    generateGraphBtn.addEventListener('click', () => {
      if (generateGraphBtn.disabled) return;

      console.log('Generate Graph button clicked');
      updateGraph();
    });

    // Show All Charts Button
    showAllChartsBtn.addEventListener('click', () => {
      if (showAllChartsBtn.disabled) return;

      console.log('Show All Charts button clicked');
      showAllCharts();
    });

    // Update button state when columns change
    function updateShowAllButtonState() {
      const hasDataType = dataTypeSelect.value && dataTypeSelect.value !== 'Choose data type...';
      const hasColumns = selectedColumns.length > 0;
      showAllChartsBtn.disabled = !(hasDataType && hasColumns);
    }

    function showAllCharts() {
      const dataType = dataTypeSelect.value;
      const selectedCols = selectedColumns;

      if (!dataType || selectedCols.length === 0) return;

      // Show loading state
      showAllChartsBtn.disabled = true;
      showAllChartsBtn.innerHTML = `
        <span class="btn-icon">
          <i class="fas fa-spinner fa-spin"></i>
        </span>
        <span class="btn-text">Generating...</span>
        <span class="btn-loading" style="display: inline;">
          <i class="fas fa-spinner fa-spin"></i>
        </span>
      `;

      const container = document.getElementById('graph-container');
      container.innerHTML = `
        <div class="charts-grid-loading">
          <div class="loading-spinner-large">
            <i class="fas fa-chart-line"></i>
          </div>
          <div class="loading-text">Generating All Chart Types</div>
          <div class="loading-subtext">Creating multiple visualizations...</div>
        </div>
      `;

      // Generate all chart types - use appropriate columns for each
      const chartTypes = ['bar', 'pie', 'histogram', 'line', 'area', 'box', 'violin', 'radar'];

      // For multi-column charts, use all selected columns
      const multiColCharts = ['heatmap', 'bubble'];
      const allChartTypes = chartTypes.concat(multiColCharts);

      const promises = allChartTypes.map(chartType => {
        let colsToUse = selectedCols;

        // For multi-column charts, ensure we have enough columns
        if (multiColCharts.includes(chartType)) {
          if (selectedCols.length < 2) {
            // Get more columns from available columns
            const availableCols = Array.from(document.getElementById('columnSelect').options)
              .map(option => option.value)
              .filter(col => col && !selectedCols.includes(col));
            colsToUse = selectedCols.concat(availableCols.slice(0, Math.max(0, 3 - selectedCols.length)));
          }
        }

        const url = buildChartUrl(dataType, colsToUse, chartType);
        return fetch(url)
          .then(response => {
            if (!response.ok) {
              throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
          })
          .then(data => ({ chartType, data }))
          .catch(error => ({ chartType, error: error.message }));
      });

      Promise.all(promises).then(results => {
        // Create grid layout
        let gridHtml = '<div class="charts-grid">';

        results.forEach(result => {
          const chartType = result.chartType;
          const title = chartType.charAt(0).toUpperCase() + chartType.slice(1) + ' Chart';

          gridHtml += `
            <div class="chart-item">
              <div class="chart-header">
                <h4>${title}</h4>
              </div>
              <div class="chart-content">
          `;

          if (result.error) {
            gridHtml += `
              <div class="chart-error">
                <i class="fas fa-exclamation-triangle"></i>
                <span>Failed to generate ${chartType} chart</span>
              </div>
            `;
          } else {
            gridHtml += `<div class="mini-chart" id="chart-${chartType}"></div>`;
          }

          gridHtml += `
              </div>
            </div>
          `;
        });

        gridHtml += '</div>';
        container.innerHTML = gridHtml;

        // Render each chart
        results.forEach(result => {
          if (!result.error) {
            const chartDiv = document.getElementById(`chart-${result.chartType}`);
            if (chartDiv) {
              Plotly.newPlot(chartDiv, result.data.data, result.data.layout, {
                responsive: true,
                displayModeBar: false,
                staticPlot: true
              });
            }
          }
        });

        // Reset button
        showAllChartsBtn.disabled = false;
        showAllChartsBtn.innerHTML = `
          <span class="btn-icon">
            <i class="fas fa-th"></i>
          </span>
          <span class="btn-text">Show All Charts</span>
          <span class="btn-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        `;
      }).catch(error => {
        console.error('Error generating all charts:', error);
        container.innerHTML = `
          <div class="alert alert-danger" style="background: rgba(220, 53, 69, 0.1); border: 1px solid #dc3545; color: #dc3545; border-radius: 8px; padding: 20px; text-align: center;">
            <i class="fas fa-exclamation-triangle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <strong>Failed to generate charts:</strong> ${error.message}
          </div>
        `;

        // Reset button
        showAllChartsBtn.disabled = false;
        showAllChartsBtn.innerHTML = `
          <span class="btn-icon">
            <i class="fas fa-th"></i>
          </span>
          <span class="btn-text">Show All Charts</span>
          <span class="btn-loading" style="display: none;">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        `;
      });
    }

    chartTypeSelect.addEventListener('change', updateGraph);
    detectChartType.addEventListener('change', updateGraph);
    autoRefreshToggle.addEventListener('change', () => { if (autoRefreshToggle.checked) startAutoRefresh(); else stopAutoRefresh(); });
    refreshNowBtn.addEventListener('click', () => updateGraph());

    // Download and grid toggle removed per request

    // Debug function for testing API endpoints
    window.testAPI = function(dataType) {
        console.log('Testing API endpoints for:', dataType);

        // Test metadata endpoint
        fetch(`/data/${dataType}`)
            .then(r => r.json())
            .then(d => console.log('Metadata endpoint result:', d))
            .catch(e => console.error('Metadata endpoint error:', e));

        // Test preview endpoint
        fetch(`/data/preview/${dataType}?page=1&per_page=1`)
            .then(r => r.json())
            .then(d => console.log('Preview endpoint result:', d))
            .catch(e => console.error('Preview endpoint error:', e));
    };

    // Debug function for testing graph generation
    window.testGraph = function(dataType, columns) {
        if (!columns || columns.length === 0) {
            console.error('Please provide columns array, e.g., testGraph("cdr", ["column1", "column2"])');
            return;
        }

        console.log('Testing graph generation for:', dataType, 'with columns:', columns);

        const url = `/graph/${encodeURIComponent(dataType)}?${columns.map(col => `column=${encodeURIComponent(col)}`).join('&')}&top_n=50`;
        console.log('Graph URL:', url);

        fetch(url)
            .then(response => {
                console.log('Graph response status:', response.status);
                return response.text();
            })
            .then(text => {
                if (text.includes('Error') || text.includes('error')) {
                    console.error('Graph error response:', text);
                } else {
                    console.log('Graph generated successfully');
                }
            })
            .catch(error => console.error('Graph fetch error:', error));
    };


    // Initial load
    if (dataTypeSelect.value) {
        console.log('Initial data type selected:', dataTypeSelect.value);
        updateColumns(dataTypeSelect.value);
    } else {
        console.log('No initial data type selected');
    }

    // Initial setup
    setTimeout(() => {
        console.log('Page loaded, initializing column select...');
        const selectElement = document.getElementById('columnSelect');

        console.log('Column select element exists:', !!selectElement);

        if (selectElement && selectElement.disabled) {
            selectElement.innerHTML = '<option disabled>Select data type first</option>';
            showOverlay('Select a data type first', 'fas fa-list-ul');
        }
    }, 500);
});

function resetAllData(buttonElement) { if (confirm('Are you sure you want to delete all uploaded data? This cannot be undone.')) { if (buttonElement) buttonElement.focus(); fetch('/reset', { method: 'POST' }).then(() => window.location.reload()); } }
</script>
{% endblock %}